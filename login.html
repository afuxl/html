<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Example</title>
</head>
<body>
  <script>
    // Fungsi untuk menyimpan token dan cookies ke localStorage
    function cachePut(key, value) {
      localStorage.setItem(key, value);
    }

    // Fungsi untuk mengambil nilai dari localStorage
    function cacheGet(key) {
      return localStorage.getItem(key);
    }

    // Fungsi untuk login pertama (mendapatkan CSRF token dan cookies)
    async function login() {
      const url = 'https://skemaraja.dephub.go.id/';
      const options = {
        method: 'GET',
        headers: {
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
          'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) Chrome/111.0.0.0 Mobile Safari/537.36'
        },
        credentials: 'include'
      };

      try {
        const response = await fetch(url, options);
        if (response.ok) {
          const cookies = response.headers.get('Set-Cookie');
          const cookieString = cookies ? cookies : '';
          const html = await response.text();

          const tokenMatch = html.match(/<input name="_token" type="hidden" value="([^"]+)">/);
          const token = tokenMatch ? tokenMatch[1] : null;

          if (token && cookieString) {
            console.log('Token didapatkan: ' + token);
            console.log('Cookies didapatkan: ' + cookieString);

            // Simpan token dan cookie di localStorage
            cachePut('sessionCookies', cookieString);
            cachePut('csrfToken', token);

            console.log('sessionCookies disimpan: ' + cacheGet('sessionCookies'));
            console.log('csrfToken disimpan: ' + cacheGet('csrfToken'));

            setTimeout(login2, 5000); // Tunggu 5 detik sebelum memanggil login2
          } else {
            console.log('Gagal mendapatkan token atau cookie.');
          }
        } else {
          console.log("Kode respons bukan 200");
        }
      } catch (error) {
        console.error('Error saat login:', error);
      }
    }

    // Fungsi untuk login kedua (menggunakan token dan cookies yang diambil sebelumnya)
    async function login2() {
      const url = 'https://skemaraja.dephub.go.id/authenticate';

      const sessionCookies = cacheGet('sessionCookies');
      const csrfToken = cacheGet('csrfToken');

      console.log('Nilai cache sessionCookies: ' + sessionCookies);
      console.log('Nilai cache csrfToken: ' + csrfToken);

      if (sessionCookies && csrfToken) {
        const options = {
          method: 'POST',
          headers: {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
            'Content-Type': 'application/x-www-form-urlencoded',
            'Cookie': sessionCookies,
            'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) Chrome/111.0.0.0 Mobile Safari/537.36'
          },
          body: new URLSearchParams({
            '_token': csrfToken,
            'nip': '7471012605900001',
            'timezone': 'Asia/Makassar',
            'location_user': '-4.159406,122.7013037',
            'password': 'qwerty',
            'status_wfh': '2',
            'shift': '1'
          }),
          credentials: 'include'
        };

        try {
          const response = await fetch(url, options);
          console.log('Kode Respons Login2:', response.status);
          const responseBody = await response.text();
          console.log('Isi Respons Login2:', responseBody);
        } catch (error) {
          console.error('Error saat login2:', error);
        }
      } else {
        console.log('Session Cookies atau CSRF Token tidak tersedia di cache.');
      }
    }

    // Panggil fungsi login pertama kali
    login();
  </script>
</body>
</html>
